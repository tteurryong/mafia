<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ì‹±ê¸€ë§ˆí”¼ì•„ - í’€ë²„ì „ (í”½ì…€ì•„ë°”íƒ€ + í–¥ìƒëœ AI)</title>
<style>
:root{--bg:#0f0f12;--card:#1b1b1f;--muted:#9aa0a6;--accent:#f6c84c;--alive:#28a745;--dead:#6c757d;}
*{box-sizing:border-box}
body{margin:0;font-family:"Malgun Gothic",system-ui,Arial;background:var(--bg);color:#eee;padding:18px;display:flex;justify-content:center}
#wrap{width:100%;max-width:1000px}
header{display:flex;justify-content:space-between;align-items:center;gap:12px}
h1{margin:0;font-size:20px}
#scoreboard{position:fixed;right:16px;top:16px;background:var(--card);padding:10px;border-radius:8px;min-width:180px;box-shadow:0 6px 18px rgba(0,0,0,0.6)}
#scoreboard h3{margin:0 0 6px 0;font-size:14px}
#game{margin-top:12px}
#controls{background:var(--card);padding:12px;border-radius:8px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
select,button{background:#2a2a2f;color:#eee;border:none;padding:8px 10px;border-radius:6px;cursor:pointer}
button:hover,select:hover{filter:brightness(1.08)}
#main{display:flex;gap:12px;margin-top:12px}
#left{flex:1}
#messages{background:linear-gradient(180deg,#151519,#101014);padding:12px;border-radius:8px;min-height:320px;max-height:640px;overflow:auto;white-space:pre-wrap;font-size:14px}
#players{margin-top:10px;display:flex;flex-wrap:wrap;gap:8px}
.playerCard{display:flex;align-items:center;gap:8px;background:#26262a;padding:8px;border-radius:8px;min-width:140px}
.avatar{width:24px;height:24px;background:#222;border-radius:4px;image-rendering:pixelated}
.playerInfo{font-size:14px}
.badge{font-size:12px;padding:3px 6px;border-radius:999px;background:#333;color:#ddd;margin-left:6px}
.alive{background:var(--alive);color:#022204}
.dead{background:var(--dead);color:#ddd;text-decoration:line-through}
.you{outline:3px solid rgba(246,200,76,0.12)}
#right{width:320px}
#inputSection{margin-top:12px;background:var(--card);padding:10px;border-radius:8px;min-height:140px}
.small{font-size:13px;color:var(--muted)}
#reveal{background:linear-gradient(90deg,#262626,#1a1a1a);padding:10px;border-radius:8px;margin-top:10px;display:none}
.pixelTiny{width:10px;height:10px;display:inline-block}
.footerNote{margin-top:8px;color:var(--muted);font-size:13px}
</style>
</head>
<body>
<div id="wrap">
  <header>
    <h1>ì‹±ê¸€ë§ˆí”¼ì•„ â€” í’€íŒ¨í‚¤ì§€</h1>
    <div class="small">í”Œë ˆì´ì–´ëŠ” 1ë²ˆ. í”½ì…€ ì•„ë°”íƒ€ Â· í–¥ìƒ AI Â· ê²½ì°° ìœ„ì¹˜ ê³µê°œ</div>
  </header>

  <div id="scoreboard">
    <h3>ì ìˆ˜íŒ</h3>
    <div id="scoreList">-</div>
  </div>

  <div id="game">
    <div id="controls">
      ì°¸ê°€ ì¸ì›:
      <select id="playerCount"></select>
      <button id="startBtn">ê²Œì„ ì‹œì‘</button>
      <button id="quickBtn">ë¹ ë¥¸ì‹œì‘(7ëª…)</button>
      <div class="small">ê²½ì°°: ì§ì ‘ ì„ íƒ ì¡°ì‚¬ Â· ì˜ì‚¬: ì œí•œ ì¹˜ë£Œ ê·œì¹™</div>
    </div>

    <div id="main">
      <div id="left">
        <div id="messages"></div>
        <div id="players"></div>
        <div id="inputSection"></div>
      </div>

      <div id="right">
        <div id="reveal"><strong>ê²Œì„ ê²°ê³¼ â€” ì—­í•  ê³µê°œ</strong><div id="revealList"></div></div>
        <div class="footerNote">ì¢…ë£Œ í›„ 'ë‹¤ì‹œ ì‹œì‘'ìœ¼ë¡œ ìƒˆ ê²Œì„ ê°€ëŠ¥. ì ìˆ˜ëŠ” ì„¸ì…˜ ë™ì•ˆ ìœ ì§€ë©ë‹ˆë‹¤.</div>
      </div>
    </div>
  </div>
</div>

<script>
/* ------------- ì´ˆê¸° ì„¸íŒ… ------------- */
const playerCountSelect = document.getElementById('playerCount');
for(let i=3;i<=12;i++){ const o=document.createElement('option'); o.value=i; o.textContent=i+'ëª…'; playerCountSelect.appendChild(o); }
const startBtn = document.getElementById('startBtn');
const quickBtn = document.getElementById('quickBtn');
const messages = document.getElementById('messages');
const playersDiv = document.getElementById('players');
const inputSection = document.getElementById('inputSection');
const revealBox = document.getElementById('reveal');
const revealList = document.getElementById('revealList');
const scoreList = document.getElementById('scoreList');

let scores = {}; // id -> score
function ensureScores(n){ for(let i=0;i<n;i++) if(scores[i]===undefined) scores[i]=0; renderScores(); }
function renderScores(){ let html=''; for(const [id,sc] of Object.entries(scores)){ html += `í”Œë ˆì´ì–´ ${parseInt(id)+1}: ${sc}ì <br/>`; } scoreList.innerHTML = html || '-'; }

/* ------------- ê²Œì„ ìƒíƒœ / ìœ í‹¸ ------------- */
let game = null;
function rolesByCount(n){
  let mafiaCount = Math.max(1, Math.floor(n/4));
  let roles = [];
  for(let i=0;i<mafiaCount;i++) roles.push('ë§ˆí”¼ì•„');
  if(n>=6){ roles.push('ì˜ì‚¬'); roles.push('ê²½ì°°'); }
  while(roles.length < n) roles.push('ì‹œë¯¼');
  for(let i=roles.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [roles[i],roles[j]]=[roles[j],roles[i]]; }
  return roles;
}
function log(msg,clear=false){ if(clear) messages.textContent=''; messages.textContent += msg + '\n'; messages.scrollTop = messages.scrollHeight; }
function alivePlayers(){ return game.players.filter(p=>p.alive); }

/* draw small pixel avatar into a container element */
function drawAvatar(container, id, role, alive){
  // create canvas 8x8 scaled to 24x24 to look pixel-art
  const size = 8;
  const scale = 3;
  const canvas = document.createElement('canvas');
  canvas.width = size; canvas.height = size;
  canvas.style.width = (size*scale)+'px';
  canvas.style.height = (size*scale)+'px';
  canvas.className='avatar';
  const ctx = canvas.getContext('2d');
  // deterministic pseudo-random from id
  function rnd(n){ const x = Math.sin(id*9781 + n*2654435761) * 10000; return Math.abs(x % 1); }
  const baseHue = Math.floor(rnd(1)*360);
  for(let y=0;y<size;y++){
    for(let x=0;x<size;x++){
      // pattern: symmetric and varied by role
      let v = rnd(x*size+y) > 0.5 ? 1 : 0;
      // role influence: mafia red tint, police blue, doctor yellow, citizen green
      let color = '#666';
      if(v){
        if(role==='ë§ˆí”¼ì•„') color = `hsl(${(baseHue+0)%360} 70% 50%)`;
        else if(role==='ê²½ì°°') color = `hsl(${(baseHue+120)%360} 70% 50%)`;
        else if(role==='ì˜ì‚¬') color = `hsl(${(baseHue+60)%360} 70% 50%)`;
        else color = `hsl(${(baseHue+200)%360} 60% 45%)`;
      } else {
        color = '#111';
      }
      ctx.fillStyle = color;
      ctx.fillRect(x,y,1,1);
    }
  }
  // overlay dead cross
  if(!alive){
    ctx.fillStyle = 'rgba(0,0,0,0.7)'; ctx.fillRect(0,0,size,size);
    ctx.fillStyle = 'rgba(255,255,255,0.9)'; ctx.font='6px monospace'; ctx.fillText('X',2,6);
  }
  container.appendChild(canvas);
}

/* render players list with avatars */
function renderPlayers(){
  playersDiv.innerHTML = '';
  game.players.forEach(p=>{
    const card = document.createElement('div'); card.className='playerCard';
    const avatarWrap = document.createElement('div'); avatarWrap.style.width='36px';
    drawAvatar(avatarWrap, p.id+7, p.role, p.alive); // seed id+7 to vary
    const info = document.createElement('div'); info.className='playerInfo';
    const title = document.createElement('div'); title.textContent = (p.id+1) + (p.id===0? ' (ë‹¹ì‹ )':'');
    const badge = document.createElement('span'); badge.className='badge';
    badge.textContent = p.alive ? 'ìƒì¡´' : 'ì‚¬ë§';
    title.appendChild(badge);
    const sub = document.createElement('div'); sub.className='small muted'; sub.style.color='#bfbfbf';
    sub.textContent = p.alive ? p.role==='ë§ˆí”¼ì•„' ? 'ì˜ì‹¬' : '' : '';
    info.appendChild(title); info.appendChild(sub);
    if(!p.alive) card.classList.add('dead');
    card.appendChild(avatarWrap); card.appendChild(info);
    if(p.id===0) card.classList.add('you');
    playersDiv.appendChild(card);
  });
}

/* button util */
function mkBtn(label, cb){ const b=document.createElement('button'); b.textContent=label; b.onclick=cb; return b; }

/* ------------- ê²Œì„ ë¡œì§ ------------- */
startBtn.onclick = ()=> startGame(parseInt(playerCountSelect.value));
quickBtn.onclick = ()=>{ playerCountSelect.value=7; startGame(7); };

function startGame(n){
  const roles = rolesByCount(n);
  game = {
    players: roles.map((r,i)=>({id:i, role:r, alive:true})),
    day:0, night:0,
    policeInvestigated:new Set(),
    policeReports:{}, // id->bool
    nightActions:{mafiaKill:null, doctorSave:null, policeCheck:null},
    policeReportThisNight:null,
    forcedVoteTarget:null
  };
  ensureScores(n);
  // reveal police index to all (user requested)
  const police = game.players.find(p=>p.role==='ê²½ì°°');
  if(police) log(`(ê³µì§€) ê²½ì°°ì€ ${police.id+1}ë²ˆ í”Œë ˆì´ì–´ì…ë‹ˆë‹¤.`, true);
  else log('(ê³µì§€) ì´ë²ˆ ê²Œì„ì— ê²½ì°° ì—­í• ì´ ì—†ìŠµë‹ˆë‹¤.', true);
  // first-night: mafia know each other -> if player is mafia show teammates
  const mafiaIds = game.players.filter(p=>p.role==='ë§ˆí”¼ì•„').map(p=>p.id);
  if(mafiaIds.length>1 && game.players[0].role==='ë§ˆí”¼ì•„'){
    log(`(ë¹„ë°€) ë‹¹ì‹ ì˜ ë§ˆí”¼ì•„ ë™ë£Œ: ${mafiaIds.filter(id=>id!==0).map(x=>x+1).join(', ')} ë²ˆ`);
  } else if(game.players[0].role==='ë§ˆí”¼ì•„'){
    log('(ë¹„ë°€) ë‹¹ì‹ ì€ ìœ ì¼í•œ ë§ˆí”¼ì•„ì…ë‹ˆë‹¤.');
  }
  renderPlayers();
  setTimeout(()=> nextPhase('night'), 700);
}

function nextPhase(phase){
  inputSection.innerHTML='';
  if(phase==='night') nightPhase();
  else if(phase==='day') dayPhase();
  else if(phase==='end') endPhase();
}

/* ---------- NIGHT ---------- */
function nightPhase(){
  game.night++;
  game.nightActions = {mafiaKill:null, doctorSave:null, policeCheck:null};
  game.policeReportThisNight = null;
  game.forcedVoteTarget = null;
  log(`\nğŸŒ™ ë°¤ ${game.night} ì‹œì‘`);
  renderPlayers();

  if(!game.players[0].alive){
    log('ë‹¹ì‹ ì€ ì‚¬ë§í•´ ë°¤ í–‰ë™ ì—†ìŒ.');
    setTimeout(()=> aiNightActions(), 600); return;
  }

  const me = game.players[0];
  if(me.role==='ë§ˆí”¼ì•„'){ log('ë‹¹ì‹ (ë§ˆí”¼ì•„)ì€ ì£½ì¼ ëŒ€ìƒì„ ì„ íƒí•˜ì„¸ìš”:'); mafiaChoose(); }
  else if(me.role==='ì˜ì‚¬'){ log('ë‹¹ì‹ (ì˜ì‚¬)ì€ ì¹˜ë£Œ ëŒ€ìƒì„ ì„ íƒí•˜ì„¸ìš”: (ê²½ì°° ë˜ëŠ” ì´ë¯¸ ì¡°ì‚¬ëœ ë¬´ì£„ì ìš°ì„ )'); doctorChoose(); }
  else if(me.role==='ê²½ì°°'){ log('ë‹¹ì‹ (ê²½ì°°)ì€ ì¡°ì‚¬ ëŒ€ìƒì„ ì„ íƒí•˜ì„¸ìš” (ë³¸ì¸ ì œì™¸):'); policeChoose(); }
  else { log('ë‹¹ì‹ (ì‹œë¯¼)ì€ ë°¤ í–‰ë™ ì—†ìŒ.'); setTimeout(()=> aiNightActions(), 600); }
}

/* mafia choose (player) */
function mafiaChoose(){
  inputSection.innerHTML='';
  const targets = alivePlayers().filter(p=>p.role!=='ë§ˆí”¼ì•„');
  targets.forEach(t=>{
    inputSection.appendChild(mkBtn((t.id+1)+'ë²ˆ', ()=>{ game.nightActions.mafiaKill=t.id; inputSection.innerHTML=''; log(`ë‹¹ì‹ (ë§ˆí”¼ì•„)ì€ ${t.id+1}ë²ˆì„ ê³µê²© ëŒ€ìƒìœ¼ë¡œ ì„ íƒí–ˆìŠµë‹ˆë‹¤.`); setTimeout(()=> aiNightActions(), 400); }));
  });
}

/* doctor choose (player) with restriction rules */
function doctorChoose(){
  inputSection.innerHTML='';
  // allowed: police id(s) + previously investigated-not-mafia + self
  const allowed = new Set();
  game.players.forEach(p=>{ if(p.role==='ê²½ì°°') allowed.add(p.id); });
  for(const [id,isMafia] of Object.entries(game.policeReports || {})){ const idn=parseInt(id); if(isMafia===false) allowed.add(idn); }
  allowed.add(0); // self always allowed
  // build candidates
  const candidates = alivePlayers().filter(p=> allowed.has(p.id));
  if(candidates.length===0){ // fallback to self
    inputSection.appendChild(mkBtn('ìê¸° ìì‹ ', ()=>{ game.nightActions.doctorSave=0; inputSection.innerHTML=''; log('ì˜ì‚¬ê°€ ìì‹ ì„ ì¹˜ë£Œí•˜ê¸°ë¡œ ì„ íƒí–ˆìŠµë‹ˆë‹¤.'); setTimeout(()=> aiNightActions(),400); }));
    return;
  }
  candidates.forEach(c=> inputSection.appendChild(mkBtn((c.id+1)+'ë²ˆ', ()=>{ game.nightActions.doctorSave=c.id; inputSection.innerHTML=''; log(`ì˜ì‚¬ê°€ ${c.id+1}ë²ˆì„ ì¹˜ë£Œ ëŒ€ìƒìœ¼ë¡œ ì„ íƒí–ˆìŠµë‹ˆë‹¤.`); setTimeout(()=> aiNightActions(),400); })));
}

/* police choose (player) */
function policeChoose(){
  inputSection.innerHTML='';
  // prefer not-yet-investigated
  const pool = alivePlayers().filter(p=> p.id!==0 && !game.policeInvestigated.has(p.id));
  const list = pool.length? pool : alivePlayers().filter(p=>p.id!==0);
  list.forEach(t=> inputSection.appendChild(mkBtn((t.id+1)+'ë²ˆ', ()=>{ game.nightActions.policeCheck=t.id; inputSection.innerHTML=''; log(`ê²½ì°°ì´ ${t.id+1}ë²ˆì„ ì¡°ì‚¬ ëŒ€ìƒìœ¼ë¡œ ì„ íƒí–ˆìŠµë‹ˆë‹¤.`); setTimeout(()=> aiNightActions(),400); })));
}

/* AI night actions - improved heuristics */
function aiNightActions(){
  const alive = alivePlayers();

  // mafia AI: choose target by score (prefer police, frequent investigators, or central threats)
  if(game.nightActions.mafiaKill === null){
    const mafiaAis = alive.filter(p=> p.role==='ë§ˆí”¼ì•„' && p.id!==0);
    if(mafiaAis.length>0){
      // build scores for targets
      const candidates = alive.filter(p=> p.role!=='ë§ˆí”¼ì•„');
      let best = null; let bestScore=-Infinity;
      candidates.forEach(c=>{
        let score=0;
        // high priority: police
        if(c.role==='ê²½ì°°') score += 40;
        // if c has investigated before (we can approximate by policeInvestigated set membership)
        if(game.policeInvestigated && game.policeInvestigated.has(c.id)) score += 12;
        // if c was investigated and found not mafia => lower priority to kill (they're "trusted") => smaller prob
        if(game.policeReports && game.policeReports[c.id] === false) score -= 10;
        // random jitter
        score += Math.random()*10;
        if(score>bestScore){ bestScore=score; best=c; }
      });
      if(best) { game.nightActions.mafiaKill = best.id; log(`AI ë§ˆí”¼ì•„ê°€ ${best.id+1}ë²ˆì„ ê³µê²© ëŒ€ìƒìœ¼ë¡œ ì„ íƒí–ˆìŠµë‹ˆë‹¤.`); }
    }
  }

  // doctor AI: prefer police or previously cleared by police, else protect self
  if(game.nightActions.doctorSave === null){
    const doctorsAI = alive.filter(p=> p.role==='ì˜ì‚¬' && p.id!==0);
    if(doctorsAI.length>0){
      let candidate = null;
      // police living?
      const cops = game.players.filter(p=> p.role==='ê²½ì°°' && p.alive).map(p=>p.id);
      if(cops.length) candidate = cops[Math.floor(Math.random()*cops.length)];
      else {
        const cleared = Object.entries(game.policeReports || {}).filter(([k,v])=>v===false).map(([k,v])=>parseInt(k)).filter(id=> game.players[id] && game.players[id].alive);
        if(cleared.length) candidate = cleared[Math.floor(Math.random()*cleared.length)];
        else candidate = doctorsAI[0].id; // self
      }
      game.nightActions.doctorSave = candidate;
      log(`AI ì˜ì‚¬ê°€ ${candidate+1}ë²ˆì„ ì¹˜ë£Œ ëŒ€ìƒìœ¼ë¡œ ì„ íƒí–ˆìŠµë‹ˆë‹¤.`);
    }
  }

  // police AI: prefer not-yet-investigated, avoid repeats
  if(game.nightActions.policeCheck === null){
    const policeAIs = alive.filter(p=> p.role==='ê²½ì°°' && p.id!==0);
    if(policeAIs.length>0){
      const pool = alive.filter(p=> p.id!==0 && !game.policeInvestigated.has(p.id));
      const poolUse = pool.length? pool : alive.filter(p=> p.id!==0);
      const pick = poolUse[Math.floor(Math.random()*poolUse.length)];
      game.nightActions.policeCheck = pick.id;
      log(`AI ê²½ì°°ì´ ${pick.id+1}ë²ˆì„ ì¡°ì‚¬ ëŒ€ìƒìœ¼ë¡œ ì„ íƒí–ˆìŠµë‹ˆë‹¤.`);
    }
  }

  setTimeout(()=> resolveNightActions(), 800);
}

/* resolve night */
function resolveNightActions(){
  const {mafiaKill, doctorSave, policeCheck} = game.nightActions;
  if(mafiaKill !== null){
    if(mafiaKill !== doctorSave){
      game.players[mafiaKill].alive = false;
      log(`\në°¤ì— ${mafiaKill+1}ë²ˆ í”Œë ˆì´ì–´ê°€ ì‚¬ë§í–ˆìŠµë‹ˆë‹¤.`);
    } else {
      log(`\nì˜ì‚¬ê°€ ${doctorSave+1}ë²ˆì„ ì¹˜ë£Œí•˜ì—¬ ì‚¬ë§ì„ ë§‰ì•˜ìŠµë‹ˆë‹¤.`);
    }
  } else log('\në§ˆí”¼ì•„ì˜ ê³µê²©ì´ ì—†ì—ˆìŠµë‹ˆë‹¤.');

  if(policeCheck !== null){
    const isMafia = game.players[policeCheck].role === 'ë§ˆí”¼ì•„';
    game.policeReports[policeCheck] = isMafia;
    game.policeInvestigated.add(policeCheck);
    game.policeReportThisNight = { target: policeCheck, isMafia };
    log(`ê²½ì°°ì´ ${policeCheck+1}ë²ˆì„ ì¡°ì‚¬í–ˆìŠµë‹ˆë‹¤ (ê²°ê³¼ëŠ” ì•„ì¹¨ ê³µê°œ).`);
  } else {
    game.policeReportThisNight = null;
  }

  renderPlayers();

  // if player dead -> auto
  if(!game.players[0].alive){
    log('\në‹¹ì‹ ì´ ì‚¬ë§í–ˆìŠµë‹ˆë‹¤. ê²Œì„ ìë™ ì§„í–‰ë©ë‹ˆë‹¤.');
    setTimeout(()=> nextPhase('day'), 900); return;
  }

  if(checkWin()){ setTimeout(()=> nextPhase('end'),900); }
  else setTimeout(()=> nextPhase('day'),900);
}

/* ---------- DAY ---------- */
function dayPhase(){
  game.day++;
  log(`\nâ˜€ ë‚® ${game.day} ì‹œì‘`);

  // reveal police result
  if(game.policeReportThisNight){
    const {target,isMafia} = game.policeReportThisNight;
    log(`ê²½ì°° ì¡°ì‚¬ ê²°ê³¼ ê³µê°œ: ${target+1}ë²ˆì€ ${isMafia? 'ë§ˆí”¼ì•„ì…ë‹ˆë‹¤!':'ë§ˆí”¼ì•„ê°€ ì•„ë‹™ë‹ˆë‹¤.'}`);
    // if found mafia -> force all citizens to vote target
    if(isMafia){
      game.forcedVoteTarget = target;
      log(`ëª¨ë“  ì‹œë¯¼(ë§ˆí”¼ì•„ ì œì™¸)ì€ ${target+1}ë²ˆì—ê²Œ íˆ¬í‘œí•©ë‹ˆë‹¤.`);
    } else game.forcedVoteTarget = null;
  } else game.forcedVoteTarget = null;

  renderPlayers();

  if(!game.players[0].alive){
    log('ë‹¹ì‹ ì€ ì£½ì–´ íˆ¬í‘œ ë¶ˆê°€. AIê°€ íˆ¬í‘œ ì§„í–‰í•©ë‹ˆë‹¤.');
    setTimeout(()=> aiVote(null), 900);
  } else {
    if(game.forcedVoteTarget !== null && game.players[0].role !== 'ë§ˆí”¼ì•„'){
      log(`ë‹¹ì‹ ì€ ì‹œë¯¼ì´ë¯€ë¡œ ìë™ìœ¼ë¡œ ${game.forcedVoteTarget+1}ë²ˆì— íˆ¬í‘œí•©ë‹ˆë‹¤.`);
      setTimeout(()=> aiVote(game.forcedVoteTarget), 700);
    } else setupVoteUI();
  }
}

/* vote UI */
function setupVoteUI(){
  inputSection.innerHTML = '<div class="small">ëˆ„êµ¬ë¥¼ ì²˜í˜•í• ê¹Œìš”? (ë³¸ì¸ ì œì™¸) â€” ë‹¤ìˆ˜ê²°, ë™ì ì´ë©´ ì²˜í˜• ì—†ìŒ</div>';
  const alive = alivePlayers().filter(p=>p.id!==0);
  alive.forEach(p=> inputSection.appendChild(mkBtn((p.id+1)+'ë²ˆ', ()=>{ inputSection.innerHTML=''; log(`ë‹¹ì‹ ì€ ${p.id+1}ë²ˆì„ íˆ¬í‘œí–ˆìŠµë‹ˆë‹¤.`); setTimeout(()=> aiVote(p.id),600); })));
}

/* AI vote (with forced target and vote tally display) */
function aiVote(playerVoted=null){
  const votes = {}; function add(id){ votes[id]=(votes[id]||0)+1; }
  if(playerVoted !== null) add(playerVoted);

  const forced = game.forcedVoteTarget;
  const ais = alivePlayers().filter(p=>p.id!==0);
  ais.forEach(ai=>{
    if(forced !== null && ai.role !== 'ë§ˆí”¼ì•„'){ add(forced); return; }
    const candidates = alivePlayers().filter(x=> x.id !== ai.id);
    if(ai.role==='ë§ˆí”¼ì•„'){
      // prefer to vote for a non-mafia with high suspicion score
      const non = candidates.filter(x=> x.role!=='ë§ˆí”¼ì•„');
      let pick = non.length? non[Math.floor(Math.random()*non.length)] : candidates[Math.floor(Math.random()*candidates.length)];
      // small bias: if police has investigated this ai and found non-mafia, avoid picking them
      add(pick.id);
    } else {
      // citizens choose random but prefer investigators (simulate smarter AI)
      const investigators = candidates.filter(x=> game.policeInvestigated.has(x.id));
      const pick = (investigators.length && Math.random()<0.5) ? investigators[Math.floor(Math.random()*investigators.length)] : candidates[Math.floor(Math.random()*candidates.length)];
      add(pick.id);
    }
  });

  // show votes
  log('\níˆ¬í‘œ ì§‘ê³„:');
  Object.entries(votes).forEach(([id,count])=> log(`${parseInt(id)+1}ë²ˆ: ${count}í‘œ`));

  // determine max
  let max = 0; let winners=[];
  for(const [id,count] of Object.entries(votes)){
    if(count>max){ max=count; winners=[parseInt(id)]; } else if(count===max){ winners.push(parseInt(id)); }
  }

  if(winners.length===1 && max>0){
    const executed = winners[0];
    game.players[executed].alive=false;
    log(`\n${executed+1}ë²ˆ í”Œë ˆì´ì–´ê°€ ì²˜í˜•ë˜ì—ˆìŠµë‹ˆë‹¤.`);
  } else {
    log('\níˆ¬í‘œ ë™ì  ë˜ëŠ” í‘œ ì—†ìŒìœ¼ë¡œ ì²˜í˜•ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
  }

  renderPlayers();

  if(!game.players[0].alive){
    log('\në‹¹ì‹ ì´ ì²˜í˜•ë˜ì–´ ê²Œì„ ìë™ ì§„í–‰ë©ë‹ˆë‹¤.');
    setTimeout(()=> { if(checkWin()) nextPhase('end'); else nextPhase('night'); },900); return;
  }

  if(checkWin()) setTimeout(()=> nextPhase('end'),900);
  else setTimeout(()=> nextPhase('night'),900);
}

/* ---------- WIN / END ---------- */
function checkWin(){
  const alive = alivePlayers();
  const mafiaAlive = alive.filter(p=>p.role==='ë§ˆí”¼ì•„').length;
  const others = alive.length - mafiaAlive;
  if(mafiaAlive===0){ log('\nğŸ‰ ì‹œë¯¼íŒ€ ìŠ¹ë¦¬!'); applyScores('citizen'); return true; }
  if(mafiaAlive >= others){ log('\nğŸ’€ ë§ˆí”¼ì•„íŒ€ ìŠ¹ë¦¬!'); applyScores('mafia'); return true; }
  return false;
}

function applyScores(winnerTeam){
  game.players.forEach(p=>{
    const team = p.role==='ë§ˆí”¼ì•„' ? 'mafia' : 'citizen';
    if(team===winnerTeam) scores[p.id] = (scores[p.id]||0)+10;
    else scores[p.id] = (scores[p.id]||0)-2;
  });
  renderScores();
}

function endPhase(){
  log('\n=== ê²Œì„ ì¢…ë£Œ â€” ì—­í•  ê³µê°œ ===');
  let html='';
  game.players.forEach(p=> html += `${p.id+1}ë²ˆ: ${p.role} (${p.alive? 'ìƒì¡´':'ì‚¬ë§'})<br/>`);
  revealBox.style.display='block';
  revealList.innerHTML = html;
  inputSection.innerHTML = '<div style="text-align:center;margin-top:10px;"><button id="restart">ë‹¤ì‹œ ì‹œì‘</button></div>';
  document.getElementById('restart').onclick = ()=> location.reload();
  renderPlayers();
}

/* ì´ˆê¸° ì ìˆ˜ ë Œë” */
renderScores();

</script>
</body>
</html>
